#!/bin/bash

# Check for required tools and install them if they are missing
if ! command -v lynis &> /dev/null; then
    dialog --title "Installation" --infobox "Installing Lynis, a security auditing tool..." 5 50
    sudo apt-get update && sudo apt-get install lynis -y
fi

# Run Lynis audit for system vulnerabilities
lynis_audit() {
    local audit_log_dir="/var/log/lynis"
    local audit_report="$audit_log_dir/report.dat"
    local audit_log="$audit_log_dir/audit.log"

    # Create audit log directory if it doesn't exist
    mkdir -p "$audit_log_dir"

    dialog --title "System Audit" --infobox "Starting Lynis system audit..." 5 50
    lynis audit system --quick 2>&1 | tee "$audit_log"

    dialog --title "Audit Completed" --msgbox "Audit completed. Review the report at $audit_report and log at $audit_log for detailed information.\nFollow the suggestions provided in the report to fix the vulnerabilities." 10 50
}

# Provide guidance to fix vulnerabilities based on Lynis report
fix_guidance() {
    local report_file="/var/log/lynis/report.dat"

    if [[ -f "$report_file" ]]; then
        dialog --title "Guidance" --infobox "Analyzing report for guidance on fixing vulnerabilities..." 5 50

        # Extract suggestions from Lynis report and display them
        suggestions=$(grep 'suggestion' "$report_file")
        dialog --title "Fix Suggestions" --msgbox "Please follow the suggestions below to improve system security:\n\n$suggestions" 20 60
    else
        dialog --title "Error" --msgbox "Lynis report not found. Please run a system audit first." 5 50
    fi
}

# Main Menu using dialog
main_menu() {
    while true; do
        exec 3>&1
        selection=$(dialog \
            --backtitle "Vulnerability Scanner and Fix Guidance" \
            --title "Main Menu" \
            --clear \
            --cancel-label "Exit" \
            --menu "Please select:" 15 50 4 \
            "1" "Perform system vulnerability scan" \
            "2" "Show guidance to fix vulnerabilities" \
            2>&1 1>&3)
        exit_status=$?
        exec 3>&-
        
        case $exit_status in
            $DIALOG_CANCEL)
                clear
                echo "Exiting..."
                exit 0
                ;;
            $DIALOG_ESC)
                clear
                echo "Exiting..."
                exit 1
                ;;
        esac
        
        case $selection in
            1)
                lynis_audit
                ;;
            2)
                fix_guidance
                ;;
            *)
                dialog --title "Error" --msgbox "Invalid option. Please try again." 5 50
                ;;
        esac
    done
}

# Run main menu
main_menu

