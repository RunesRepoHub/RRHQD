#!/bin/bash

# Check for required tools and install them if they are missing
if ! command -v lynis &> /dev/null; then
    echo "Installing Lynis, a security auditing tool..."
    sudo apt-get update && sudo apt-get install lynis -y
fi

# Run Lynis audit for system vulnerabilities
lynis_audit() {
    local audit_log_dir="/var/log/lynis"
    local audit_report="$audit_log_dir/report.dat"
    local audit_log="$audit_log_dir/audit.log"

    # Create audit log directory if it doesn't exist
    mkdir -p "$audit_log_dir"

    echo "Starting Lynis system audit..."
    lynis audit system --quick 2>&1 | tee "$audit_log"

    echo "Audit completed. Review the report at $audit_report and log at $audit_log for detailed information."
    echo "Follow the suggestions provided in the report to fix the vulnerabilities."
}

# Provide guidance to fix vulnerabilities based on Lynis report
fix_guidance() {
    local report_file="/var/log/lynis/report.dat"

    if [[ -f "$report_file" ]]; then
        echo "Analyzing report for guidance on fixing vulnerabilities..."

        # Extract suggestions from Lynis report
        grep 'suggestion' "$report_file" | while read -r line ; do
            echo "$line"
        done

        echo "Please follow the above suggestions to improve system security."
    else
        echo "Lynis report not found. Please run a system audit first."
    fi
}

# Main Menu
main_menu() {
    while true; do
        echo "Vulnerability Scanner and Fix Guidance"
        echo "1. Perform system vulnerability scan"
        echo "2. Show guidance to fix vulnerabilities"
        echo "3. Exit"
        read -p "Please select an option: " option

        case $option in
            1) lynis_audit ;;
            2) fix_guidance ;;
            3) echo "Exiting..."; exit 0 ;;
            *) echo "Invalid option. Please try again." ;;
        esac
    done
}

# Run main menu
main_menu
